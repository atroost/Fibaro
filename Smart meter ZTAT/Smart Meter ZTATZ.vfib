{"name":"Slimme meter","type":"virtual_device","properties":{"deviceIcon":1001,"currentIcon":"1001","log":"transfer ok","logTemp":"TxtGreen","mainLoop":"-- Ophalen device id voor de labels\nlocal selfId = fibaro:getSelfId();\n-- Ophalen ip adres van IP veld\nlocal ip = fibaro:get(selfId, 'IPAddress');\n-- Ophalen port van port veld\nlocal port = fibaro:get(selfId, 'TCPPort');\n-- Ophalen Json table uit de PI1monitor\n--\n-- Inhoud Json result\n--\n--TIMESTAMP_LOCAL\n--TIMESTAMP_UTC \n--CONSUMPTION_KWH_LOW \n--CONSUMPTION_KWH_HIGH   \n--PRODUCTION_KWH_LOW   \n--PRODUCTION_KWH_HIGH \n--CONSUMPTION_KW \n--PRODUCTION_KW \n--TARIFCODE   \n--CONSUMPTION_GAS_M3   \n--CONSUMPTION_GAS_DELTA_M3 \n\n--\nlocal PI1 = Net.FHttp(ip, port)\napiResult, apiStatus, apiErrorCode = PI1:GET(\"/api/v1/powergas/minute/?limit=1&json=object\")\nif (apiStatus == \"200\") then\n\tapiResult = apiResult:gsub(\"%[\", \"\") -- clean up the apiResult by removing [ and ]\n\tapiResult = apiResult:gsub(\"%]\", \"\")\nresult = json.decode(apiResult);\n-- Actuele tijd van de meting\n  act_datumTijd = result.TIMESTAMP_lOCAL\n  fibaro:call(selfId, \"setProperty\", \"ui.Label1.value\", act_datumTijd)\n-- Tariefcode D = Dal P= Piek\n  tarief_code = result.TARIFCODE\n  fibaro:call(selfId, \"setProperty\", \"ui.Label2.value\", tarief_code)\n-- Actueel netto verbruik (- opbrengst) naar veld 2\n  act_verbruik = result.CONSUMPTION_KW\n  act_opbrengst = result.PRODUCTION_KW\n  netto_verbruik = act_verbruik - act_opbrengst\n  fibaro:call(selfId, \"setProperty\", \"ui.Label3.value\", netto_verbruik..\" Wh\")\n-- Meterstanden   \n  cum_verbruik_dal = result.CONSUMPTION_KWH_LOW\n  fibaro:call(selfId, \"setProperty\", \"ui.Label5.value\", cum_verbruik_dal..\" KWh\")\n  cum_verbruik_piek = result.CONSUMPTION_KWH_HIGH\n  fibaro:call(selfId, \"setProperty\", \"ui.Label6.value\", cum_verbruik_piek..\" KWh\")\n  cum_opbrengst_dal = result.PRODUCTION_KWH_LOW\n  fibaro:call(selfId, \"setProperty\", \"ui.Label7.value\", cum_opbrengst_dal..\" KWh\")\n  cum_opbrengst_piek = result.PRODUCTION_KWH_HIGH\n  fibaro:call(selfId, \"setProperty\", \"ui.Label8.value\", cum_opbrengst_piek..\" KWh\")\n-- Gas\ncum_verbruik_gas = result.CONSUMPTION_GAS_M3\n  fibaro:call(selfId, \"setProperty\", \"ui.Label9.value\", cum_verbruik_gas..\" M3\")\n  fibaro:debug(CONSUMPTION_KW)\n  --update\n  fibaro:call(selfId, \"setProperty\", \"ui.Label10.value\", os.date(\"%c\"));\n  fibaro:call(selfId, \"setProperty\", \"ui.lblError.value\", \"transfer ok\");\n  fibaro:log(\"transfer ok\");\nelse\n  fibaro:debug(\"error: \"..apiStatus..\",\"..apiErrorCode);\n  fibaro:log(\"Error getting data...\");\n  fibaro:call(selfId, \"setProperty\", \"ui.lblError.value\", \"Error getting data\");\nend","ui.Label1.value":"2019-08-11 22:17:00","ui.Label10.value":"Sun Aug 11 22:18:17 2019","ui.Label2.value":"D","ui.Label3.value":"3.5007142857143 Wh","ui.Label5.value":"3715.611 KWh","ui.Label6.value":"2722.44 KWh","ui.Label7.value":"1646.821 KWh","ui.Label8.value":"3985.975 KWh","ui.Label9.value":"3005.577 M3","ui.lblError.value":"transfer ok","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Tijd","name":"Label1","favourite":false,"main":false}]},{"type":"label","elements":[{"id":2,"lua":false,"waitForResponse":false,"caption":"Tarief Dal/Piek","name":"Label2","favourite":false,"main":false}]},{"type":"label","elements":[{"id":3,"lua":false,"waitForResponse":false,"caption":"Verbruik nu","name":"Label3","favourite":false,"main":false}]},{"type":"label","elements":[{"id":4,"lua":false,"waitForResponse":false,"caption":"Verbruik Dal","name":"Label5","favourite":false,"main":false}]},{"type":"label","elements":[{"id":5,"lua":false,"waitForResponse":false,"caption":"Verbruik Piek","name":"Label6","favourite":false,"main":false}]},{"type":"label","elements":[{"id":6,"lua":false,"waitForResponse":false,"caption":"Opbrengst Dal","name":"Label7","favourite":false,"main":false}]},{"type":"label","elements":[{"id":7,"lua":false,"waitForResponse":false,"caption":"Opbrengst Piek","name":"Label8","favourite":false,"main":false}]},{"type":"label","elements":[{"id":8,"lua":false,"waitForResponse":false,"caption":"Gas","name":"Label9","favourite":false,"main":false}]},{"type":"label","elements":[{"id":9,"lua":false,"waitForResponse":false,"caption":"Update","name":"Label10","favourite":false,"main":false}]},{"type":"label","elements":[{"id":10,"lua":false,"waitForResponse":false,"caption":"Status","name":"lblError","favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}
